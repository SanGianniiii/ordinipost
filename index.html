<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/> 
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">
  <title>Ordini Post - Prenotazioni</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to right, #e8f5e9, #c8e6c9);
      margin: 0;
      /* CORREZIONE 2: Usa le aree di sicurezza per il padding dinamico */
      /* Il padding di 2rem deve essere aggiunto *dopo* l'area di sicurezza */
      padding: 2rem; 
      padding-top: calc(2rem + env(safe-area-inset-top, 0px));
      padding-bottom: calc(2rem + env(safe-area-inset-bottom, 0px));
      padding-left: calc(2rem + env(safe-area-inset-left, 0px));
      padding-right: calc(2rem + env(safe-area-inset-right, 0px));
      color: #2e7d32;
    }

    /* Splash screen deve coprire tutto lo schermo, incluse le aree sicure */
    #splash {
      position: fixed;
      top: 0; left: 0;
      /* Usa 100% invece di 100vw/vh in questo contesto */
      width: 100%; 
      height: 100%; 
      background-color: #e8f5e9;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      opacity: 1;
      transition: opacity 1s ease-out;
    }

    #splash img {
      width: 400px;
      height: 400px;
      animation: fadeIn 1s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
      /* Se l'header fosse fixed, avrebbe bisogno anche lui del padding-top */
    }

    header img {
      width: 120px;
      height: 120px;
    }

    h2 {
      margin: 0;
      font-size: 2.4rem;
    }
    
    /* ... il resto del tuo CSS Ã¨ invariato ... */

    select, input[type="number"], button {
      width: 100%;
      padding: 0.7rem;
      margin-top: 1rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #a5d6a7;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      margin-top: 1rem;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 128, 0, 0.2);
    }

    th, td {
      padding: 0.8rem;
      text-align: center;
      border-bottom: 1px solid #e0f2f1;
    }

    th {
      background-color: #a5d6a7;
      color: white;
    }

    button {
      background-color: #2e7d32;
      color: white;
      border: none;
      margin-top: 1.5rem;
      font-weight: bold;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #1b5e20;
    }


    #modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    #modal-content {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      max-width: 90%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    #modal-content h3 {
      margin-top: 0;
      color: #2e7d32;
    }

    #modal-content button {
      width: auto;
      margin: 1rem 0.5rem 0 0;
    }

    @media (min-width: 768px) {
      select, input[type="number"], button {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        display: block;
      }
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #2e7d32;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-left: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    td input[type="number"] {
      max-width: 80px;
      box-sizing: border-box;
    }
    
    /* MODAL RIEPILOGO: Aggiunto fix per aree di sicurezza se l'utente scorre */
    #modal-riepilogo > div {
        /* Assicura che l'interno del modal non sia tagliato dalle barre */
        max-height: calc(80vh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px)); 
    }
  </style>
</head>
<body>
<script type="module">
Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
Â  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyAY8l_GGRWPWi5BFpirUMXd2JN0MVZZpYM",
Â  Â  authDomain: "ordinipost-fcc7f.firebaseapp.com",
Â  Â  projectId: "ordinipost-fcc7f",
Â  Â  storageBucket: "ordinipost-fcc7f.appspot.com",
Â  Â  messagingSenderId: "363847145933",
Â  Â  appId: "1:363847145933:web:d1590848833eb147590c84",
Â  };

Â  const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// Registra il Service Worker
navigator.serviceWorker
Â  .register('/ordinipost/firebase-messaging-sw.js')
Â  .then(() => {
Â  Â  console.log('âœ… Service Worker registrato');

Â  Â  return navigator.serviceWorker.ready;
Â  })
Â  .then((registration) => {
Â  Â  console.log('ğŸŸ¢ Service Worker attivo');

Â  Â  return Notification.requestPermission().then((permission) => {
Â  Â  Â  if (permission === 'granted') {
Â  Â  Â  Â  return getToken(messaging, {
Â  Â  Â  Â  Â  vapidKey: 'Iqwy9NBf6sYYad6tPbLs-DiSbgd5DF-Aowk7rmzl5Cw',
Â  Â  Â  Â  Â  serviceWorkerRegistration: registration,
Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  throw new Error('âŒ Permesso notifiche non concesso');
Â  Â  Â  }
Â  Â  });
Â  })
Â  .then((token) => {
Â  Â  console.log('ğŸ“¬ FCM Token ricevuto:', token);
Â  })
Â  .catch((err) => {
Â  Â  console.error('âŒ Errore:', err);
Â  });


Â  // ğŸ‘‰ Gestione messaggio quando la pagina Ã¨ aperta
Â  onMessage(messaging, (payload) => {
Â  Â  console.log("ğŸ“© Messaggio ricevuto in foreground:", payload);
Â  Â  alert(`ğŸ“¢ Notifica: ${payload.notification.title} - ${payload.notification.body}`);
Â  });
</script>

Â  Â  <div id="splash">
Â  Â  <img src="logo.png" alt="Logo">
Â  </div>

Â  <header>
Â  Â  <img src="logo.png" alt="Logo" />
Â  Â  <h2>WebApp Ordini Post</h2>
Â  </header>

Â  <label for="nome">Seleziona Famiglia di Padrini:</label>
Â  <select id="nome">
Â  Â  <option value="">-- Seleziona la tua Famiglia --</option>
Â  Â  <option>Carapezza</option>
Â  Â  <option>Caruso</option>
Â  Â  <option>Di Maria</option>
Â  Â  <option>Marino</option>
Â  Â  <option>Massimino</option>
Â  Â  <option>Milanese</option>
Â  Â  <option>Nicosia</option>
Â  Â  <option>Pantellaro</option>
Â  Â  <option>Romano</option>
Â  Â  <option>Ruiz</option>
Â  Â  <option>Scala</option>
Â  Â  <option>Tanasi</option>
Â  Â  <option>Zammillo</option>
Â  </select>

Â  <div id="tabella-g">
Â  Â  <h3>DisponibilitÃ  prodotti</h3>
Â  Â  <div id="prodotti"></div>
Â  </div>

Â  <button onclick="confermaOrdine()">Prenota</button>
Â  <button onclick="mostraRiepilogoPrenotazioni()">Riepilogo Prenotazioni</button>


Â Â 

Â  Â  <div id="modal">
Â  Â  <div id="modal-content">
Â  Â  Â  <h3>Conferma ordine</h3>
Â  Â  Â  <pre id="riepilogoModal"></pre>
Â  Â  Â  <div id="messaggioAttesa" style="margin-top:1rem; display:none; color:#2e7d32; font-weight:bold;">
Â  Â  Â  Â  â³ Attendi, il tuo ordine sta per essere processato...
Â  Â  Â  Â  <span class="spinner"></span>
Â  Â  Â  </div>
Â  Â  Â  <button onclick="inviaOrdine()">Conferma</button>
Â  Â  Â  <button onclick="chiudiModal()">Annulla</button>
Â  Â  </div>
Â  </div>
<div id="modal-riepilogo" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
Â  <div style="background:#fff; padding:20px; border-radius:10px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto;">
Â  Â  <h3>Riepilogo Prenotazioni</h3>
Â  Â  <div id="spinner-riepilogo" style="display:none; color:#2e7d32; font-weight:bold; margin-bottom: 1rem;">
Â  Generazione riepilogo in corso... <span class="spinner"></span>
</div>

Â  Â  <pre id="contenuto-riepilogo" style="white-space: pre-wrap; font-family: monospace;"></pre>
Â  Â  <button onclick="document.getElementById('modal-riepilogo').style.display='none'">Chiudi</button>
Â  </div>
</div>
Â  <script>
Â  Â  const scriptUrl = "https://script.google.com/macros/s/AKfycbzeUhhMfbrOoNOC0poIgowaD-LII689HLXpoHrv9GwsI5lx5TqEtva47ZW3DHJI1qjMkA/exec";
Â  Â  let prodotti = [];
Â  Â  let ordineDaInviare = [];

Â  Â  async function caricaProdotti() {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(scriptUrl + "?action=read");
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  prodotti = data;
Â  Â  Â  Â  mostraTabella();

Â  Â  Â  Â  const salvato = localStorage.getItem("famiglia");
Â  Â  Â  Â  if (salvato) document.getElementById("nome").value = salvato;
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  alert("Errore nel caricamento dei dati: " + e.message);
Â  Â  Â  }
Â  Â  }

Â  Â  function mostraTabella() {
Â  Â  Â  let html = "<table><tr><th>Prodotto</th><th>Disponibile</th><th>QuantitÃ </th></tr>";
Â  Â  Â  prodotti.forEach((p, i) => {
Â  Â  Â  Â  html += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${p.tipo}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${p.giacenza}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.giacenza <= 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? '<span style="color:red; font-weight:bold;">Sold Out</span>'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<input type="number" id="quantita-${i}" min="0" max="${p.giacenza}" />`
Â  Â  Â  Â  Â  Â  Â  Â  Â  }</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  });
Â  Â  Â  html += "</table>";
Â  Â  Â  document.getElementById("prodotti").innerHTML = html;
Â  Â  }

Â  Â  function confermaOrdine() {
Â  Â  Â  const nome = document.getElementById("nome").value.trim();
Â  Â  Â  if (!nome) return alert("Seleziona il nome della tua famiglia.");

Â  Â  Â  localStorage.setItem("famiglia", nome);

Â  Â  Â  const ordine = [];
Â  Â  Â  for (let i = 0; i < prodotti.length; i++) {
Â  Â  Â  Â  const p = prodotti[i];
Â  Â  Â  Â  const input = document.getElementById(`quantita-${i}`);
Â  Â  Â  Â  if (!input) continue;

Â  Â  Â  Â  const qty = parseInt(input.value) || 0;

Â  Â  Â  Â  if (qty > p.giacenza) {
Â  Â  Â  Â  Â  alert(`Attenzione: la giacenza del prodotto "${p.tipo}" Ã¨ inferiore alla richiesta, modificalo.`);
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (qty > 0) {
Â  Â  Â  Â  Â  ordine.push({ nome, prodotto: p.tipo, quantita: qty });
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  if (ordine.length === 0) return alert("Nessun prodotto selezionato.");

Â  Â  Â  let riepilogo = `Famiglia: ${nome}\n\n`;
Â  Â  Â  ordine.forEach(o => riepilogo += `- ${o.prodotto}: ${o.quantita}\n`);

Â  Â  Â  ordineDaInviare = ordine;
Â  document.getElementById("riepilogoModal").innerText = riepilogo;

Â  const confermaBtn = document.querySelector('#modal-content button:nth-child(4)');
Â  const annullaBtn = document.querySelector('#modal-content button:nth-child(5)');

Â  if (confermaBtn) {
Â  Â  confermaBtn.style.display = "inline-block";
Â  Â  confermaBtn.disabled = false;
Â  }
Â  if (annullaBtn) {
Â  Â  annullaBtn.style.display = "inline-block";
Â  }

Â  document.getElementById("modal").style.display = "flex";

Â  Â  }

Â  Â  function chiudiModal() {
Â  Â  Â  document.getElementById("modal").style.display = "none";
Â  Â  Â  document.getElementById("messaggioAttesa").style.display = "none";
Â  Â  }

Â  Â Â 


Â  Â  async function inviaOrdine() {
Â  Â  Â  const attesa = document.getElementById("messaggioAttesa");
Â  Â  Â  const confermaBtn = document.querySelector('#modal-content button:nth-child(4)');
Â  Â  Â  const annullaBtn = document.querySelector('#modal-content button:nth-child(5)');

Â  Â  Â  if (attesa) attesa.style.display = "block";
Â  Â  Â  if (confermaBtn) confermaBtn.style.display = "none";
Â  Â  Â  if (annullaBtn) annullaBtn.style.display = "none";

Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(scriptUrl, {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  body: JSON.stringify({ action: "prenota", ordine: ordineDaInviare })
Â  Â  Â  Â  });
Â  Â  Â  Â  const out = await res.json();

Â  Â  Â  Â  const notifica = document.getElementById("notifica-successo");
Â  Â  Â  Â  if (notifica) {
Â  Â  Â  Â  Â  notifica.style.display = "block";
Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  notifica.style.display = "none";
Â  Â  Â  Â  Â  }, 4000);
Â  Â  Â  Â  }

Â  Â  Â  Â  document.getElementById("modal").style.display = "none";
Â  Â  Â  Â  if (attesa) attesa.style.display = "none";
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  alert("Errore durante l'invio dell'ordine: " + e.message);
Â  Â  Â  Â  if (attesa) attesa.style.display = "none";
Â  Â  Â  } finally {
Â  Â  Â  Â  if (document.getElementById("modal").style.display === "flex") {
Â  Â  Â  Â  Â  if (confermaBtn) confermaBtn.style.display = "inline-block";
Â  Â  Â  Â  Â  if (annullaBtn) annullaBtn.style.display = "inline-block";
Â  Â  Â  Â  }
Â  Â  Â  Â  if (confermaBtn) confermaBtn.disabled = false;
Â  Â  Â  }

Â  Â  Â  caricaProdotti();
Â  Â  }

Â  Â  // Splash screen dissolve
Â  Â  window.addEventListener("load", () => {
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  const splash = document.getElementById("splash");
Â  Â  Â  Â  splash.style.opacity = 0;
Â  Â  Â  Â  setTimeout(() => splash.style.display = "none", 1000);
Â  Â  Â  }, 2500);
Â  Â  });

Â  Â  window.onload = caricaProdotti;
Â  Â  if ('serviceWorker' in navigator) {
Â  navigator.serviceWorker.register('/ordinipost/firebase-messaging-sw.js')
Â  Â  .then(() => console.log('âœ… Service Worker registrato'))
Â  Â  .catch(err => console.error('âŒ Errore Service Worker:', err));
Â  Â  }

Â  Â  async function mostraRiepilogoPrenotazioni() {
Â  const nominativo = document.getElementById('nome').value.trim();
Â  if (!nominativo) {
Â  Â  alert("Seleziona prima un nominativo dalla lista.");
Â  Â  return;
Â  }

Â  const spinner = document.getElementById("spinner-riepilogo");
Â  const contenuto = document.getElementById("contenuto-riepilogo");

Â  // Pulisci contenuto e mostra spinner
Â  contenuto.innerText = "";
Â  spinner.style.display = "block";
Â  document.getElementById('modal-riepilogo').style.display = "flex";

Â  try {
Â  Â  const url = scriptUrl + "?action=riepilogo&nominativo=" + encodeURIComponent(nominativo);
Â  Â  const res = await fetch(url);
Â  Â  if (!res.ok) throw new Error("Errore nel recupero dati");
Â  Â  const data = await res.json();

Â  Â  spinner.style.display = "none"; // Nascondi spinner

Â  Â  if (data.length === 0) {
Â  Â  Â  contenuto.innerText = `Nessuna prenotazione trovata per ${nominativo}.`;
Â  Â  } else {
Â  Â  Â  let testo = `Riepilogo prenotazioni per ${nominativo}:\n\n`;
Â  Â  Â  data.forEach(item => {
Â  Â  Â  Â  testo += `- ${item.prodotto}: ${item.valore}\n`;
Â  Â  Â  });
Â  Â  Â  contenuto.innerText = testo;
Â  Â  }
Â  } catch (err) {
Â  Â  spinner.style.display = "none"; // Nascondi spinner in caso di errore
Â  Â  contenuto.innerText = "Errore durante il caricamento del riepilogo: " + err.message;
Â  }
}
Â if ('Notification' in window && navigator.serviceWorker) {
Â  Â  Â  Notification.requestPermission().then(permission => {
Â  Â  Â  Â  if (permission === 'granted') {
Â  Â  Â  Â  Â controllaGiacenze(); // Avvio immediato
Â  Â  Â  setInterval(controllaGiacenze, 300000); // Ogni 5 minuti
Â  Â  }
Â  });
}
Â  Â  function controllaGiacenze() {
Â  fetch('https://script.google.com/macros/s/AKfycbzeUhhMfbrOoNOC0poIgowaD-LII689HLXpoHrv9GwsI5lx5TqEtva47ZW3DHJI1qjMkA/exec?action=read')
Â  Â  .then(res => res.json())
Â  Â  .then(data => {
Â  Â  Â  data.forEach(prodotto => {
Â  Â  Â  Â  const { tipo, giacenza } = prodotto;

Â  Â  Â  Â  let messaggio = null;

Â  Â  Â  Â  if (giacenza === 0) messaggio = `âš ï¸ Il prodotto ${tipo} Ã¨ esaurito!`;
Â  Â  Â  Â  else if (giacenza === 1) messaggio = `âš ï¸ Ultima unitÃ  per ${tipo}!`;
Â  Â  Â  Â  else if (giacenza <= 5) messaggio = `ğŸ“¦ Scorte molto basse (${giacenza}) per ${tipo}`;
Â  Â  Â  Â  else if (giacenza <= 10) messaggio = `â„¹ï¸ Solo ${giacenza} unitÃ  rimaste per ${tipo}`;
Â  Â  Â  Â  else if (giacenza <= 20) messaggio = `â„¹ï¸ Scorte in calo per ${tipo} (${giacenza})`;

Â  Â  Â  Â  if (messaggio && Notification.permission === 'granted') {
Â  Â  Â  Â  Â  navigator.serviceWorker.getRegistration().then(reg => {
Â  Â  Â  Â  Â  Â  if (reg) {
Â  Â  Â  Â  Â  Â  Â  reg.showNotification('Avviso Scorte', {
Â  Â  Â  Â  Â  Â  Â  Â  body: messaggio,
Â  Â  Â  Â  Â  Â  Â  Â  icon: 'logo.png'
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  });
}
Â  </script>

Â  <div id="notifica-successo" style="
Â  Â  display: none;
Â  Â  position: fixed;
Â  Â  bottom: 20px;
Â  Â  left: 50%;
Â  Â  transform: translateX(-50%);
Â  Â  background-color: #c8e6c9;
Â  Â  color: #2e7d32;
Â  Â  padding: 1rem 1.5rem;
Â  Â  text-align: center;
Â  Â  font-weight: bold;
Â  Â  border-radius: 8px;
Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
Â  Â  z-index: 9999;
Â  ">
Â  Â  âœ… Ordine inviato con successo!
Â  </div>

</body>
</html>
