<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">
  <title>Ordini Post - Prenotazioni</title>
  <style>
/* --- STILI BASE E LAYOUT (Colori App Originale) --- */
body {
    font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: linear-gradient(to right, #e8f5e9, #c8e6c9);
    margin: 0;
    padding: 1rem;
    color: #2e7d32;
    min-height: 100vh;
}

header {
    display: flex;
    align-items: center;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 1.5rem;
}
header img {
    width: 60px; height: 60px;
    object-fit: contain;
}
h2 { margin: 0; font-size: 1.5rem; color: #2e7d32; }

select, input[type="number"], input[type="text"], button {
    width: 100%;
    padding: 0.8rem;
    margin-top: 0.5rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #a5d6a7;
    box-sizing: border-box;
}

label { font-weight: bold; color: #2e7d32; display: block; margin-top: 1rem; }

.table-wrapper {
    width: 100%;
    overflow-x: auto;
    margin-top: 1rem;
    border-radius: 8px;
    background-color: white;
    box-shadow: 0 2px 8px rgba(0, 128, 0, 0.15);
}

table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}

th, td {
    padding: 0.8rem 0.4rem;
    text-align: center;
    border-bottom: 1px solid #e0f2f1;
    word-wrap: break-word;
    font-size: 0.9rem;
}

th { background-color: #a5d6a7; color: white; font-weight: 600; }

.col-prod { width: 30%; text-align: left; padding-left: 10px; color: #2e7d32; }
.col-disp { width: 15%; }
.col-qta { width: 20%; }
.col-nota { width: 35%; }

#modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 30000; }
#modal-riepilogo, #modal-dettaglio-persone { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 20000; }

.modal-content-box {
    background: white; padding: 20px; border-radius: 12px;
    width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0,128,0,0.2);
}

#loading-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: white;
    z-index: 50000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

#status-message {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px 40px;
    border-radius: 15px;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    text-align: center;
    z-index: 60000; 
    display: none;
    box-shadow: 0 10px 30px rgba(0,128,0,0.3);
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popIn {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

.status-success { background-color: #2e7d32; border: 2px solid #1b5e20; }
.status-error { background-color: #d32f2f; border: 2px solid #b71c1c; }

.card-persona { border: 1px solid #c8e6c9; border-radius: 10px; padding: 10px; margin-bottom: 15px; background-color: #fafafa; }
.card-persona h4 { margin: 0 0 10px 0; color: #2e7d32; border-bottom: 2px solid #2e7d32; padding-bottom: 5px; }

.spinner {
    display: inline-block; width: 30px; height: 30px;
    border: 4px solid rgba(46, 125, 50, 0.2);
    border-top: 4px solid #2e7d32;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

button { background-color: #2e7d32; color: white; border: none; font-weight: bold; margin-top: 1rem; cursor: pointer; transition: background 0.3s; }
button:hover { background-color: #1b5e20; }
.btn-secondary { background-color: #6c757d; }
.btn-dark { background-color: #1b5e20; }
</style>
</head>
<body>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/ordinipost/firebase-messaging-sw.js')
        .then(() => console.log('‚úÖ Service Worker registrato per PWA'))
        .catch(err => console.error('‚ùå Errore SW:', err));
    });
  }
</script>

<div id="loading-overlay">
    <div class="spinner" style="width: 50px; height: 50px;"></div>
    <h2 style="margin-top: 20px;">Attendi ricarica riepilogo...</h2>
    <p style="color: #666;">Stiamo sincronizzando i tuoi ordini</p>
</div>

<div id="status-message"></div>

<header>
  <img src="logo.png" alt="Logo" onerror="this.style.display='none'"/>
  <h2>Ordini Colombe</h2>
</header>

<div style="max-width: 600px; margin: auto;">
    <label for="nome">üë§ Famiglia Padrini:</label>
    <select id="nome">
      <option value="">-- Seleziona --</option>
      <option>Carapezza</option><option>Caruso</option><option>Di Maria</option>
      <option>Marino</option><option>Massimino</option><option>Milanese</option>
      <option>Murabito</option><option>Nicosia</option><option>Pantellaro</option>
      <option>Porto</option><option>Romano</option><option>Ruiz</option>
      <option>Scala</option><option>Tanasi</option><option>Zammillo</option>
    </select>

    <div id="sezione-prodotti">
      <h3 style="color: #2e7d32; margin-top: 1.5rem;">üì¶ Disponibilit√†</h3>
      <div id="lista-prodotti"></div>
    </div>

    <button onclick="confermaOrdine()">üöÄ Invia Prenotazione</button>
    <button class="btn-dark" onclick="mostraRiepilogoPrenotazioni()">üìä Vedi Mio Riepilogo</button>
</div>

<div id="modal">
  <div class="modal-content-box">
    <h3 id="titoloModal" style="color: #2e7d32; margin-top: 0;">Conferma Azione</h3>
    <div id="riepilogoCorpo" style="background: #e8f5e9; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; font-size: 0.9rem; border: 1px solid #a5d6a7;"></div>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button id="btnEsegui" onclick="eseguiOperazioneBackend()" style="margin:0;">Conferma</button>
        <button onclick="chiudiModal()" class="btn-secondary" style="margin:0;">Annulla</button>
    </div>
  </div>
</div>

<div id="modal-riepilogo">
  <div class="modal-content-box" style="max-width: 600px;">
    <h3 style="margin-top: 0; color:#2e7d32;">Riepilogo Famiglia</h3>
    <div id="contenuto-riepilogo"></div>
    <button class="btn-secondary" onclick="document.getElementById('modal-riepilogo').style.display='none'">Chiudi</button>
  </div>
</div>

<div id="modal-dettaglio-persone">
  <div class="modal-content-box" style="max-width: 650px; width: 95%;">
    <h3 style="margin-top: 0; color:#2e7d32;">Dettaglio per Persona</h3>
    <div id="contenuto-dettaglio"></div>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="preparaModificaDettaglio()" style="margin:0;">Applica Modifiche</button>
        <button class="btn-secondary" onclick="document.getElementById('modal-dettaglio-persone').style.display='none'" style="margin:0;">Chiudi</button>
    </div>
  </div>
</div>

<script>
  // ECCO L'URL GAS UFFICIALE:
  const scriptUrl = "https://script.google.com/macros/s/AKfycbzeUhhMfbrOoNOC0poIgowaD-LII689HLXpoHrv9GwsI5lx5TqEtva47ZW3DHJI1qjMkA/exec";
  let prodottiGlobal = [];
  let payloadTemporaneo = [];

  const PREZZI = { "pistacchio": 19, "nocciola": 19, "fondente": 19, "mandorla": 19, "caffe": 19, "pera ciocco": 17, "arancia candita": 17, "frutti di bosco": 17, "jelly limone arancia rossa": 19 };

  function getPrezzo(nome) {
      const n = nome.toLowerCase();
      for (const [k, v] of Object.entries(PREZZI)) { if (n.includes(k)) return v; }
      return 0;
  }

  async function caricaDati() {
    try {
      const res = await fetch(scriptUrl + "?action=read");
      prodottiGlobal = await res.json();
      renderizzaTabellaPrincipale();
      const fav = localStorage.getItem("famiglia");
      if (fav) document.getElementById("nome").value = fav;
    } catch (e) { console.error("Errore caricamento: " + e.message); }
  }

  function renderizzaTabellaPrincipale() {
    let html = `<div class="table-wrapper"><table><thead><tr><th class="col-prod" style="color:white;">Prodotto</th><th class="col-disp">Disp.</th><th class="col-qta">Quantit√†</th><th class="col-nota">Nota</th></tr></thead><tbody>`;
    
    prodottiGlobal.forEach((p, i) => {
      const isEsaurito = p.giacenza <= 0;
      const stileRiga = isEsaurito ? 'background-color: #f9f9f9; color: #999;' : '';

      html += `<tr style="${stileRiga}">
                <td class="col-prod" style="font-weight:600;">${p.tipo}</td>
                <td class="col-disp">${p.giacenza}</td>
                <td class="col-qta">
                  ${!isEsaurito 
                    ? `<input type="number" id="qta-${i}" min="0" max="${p.giacenza}" placeholder="0">` 
                    : `<span style="color:#d32f2f; font-weight:bold; font-size:0.8rem;">SOLD OUT</span>`
                  }
                </td>
                <td class="col-nota">
                  <input type="text" id="nota-${i}" placeholder="${isEsaurito ? '' : 'Es: Mario'}" ${isEsaurito ? 'disabled style="background:#f2f2f2; border:none;"' : ''}>
                </td>
               </tr>`;
    });
    
    html += `</tbody></table></div>`;
    document.getElementById("lista-prodotti").innerHTML = html;
  }

  function confermaOrdine() {
    const nomeFamiglia = document.getElementById("nome").value;
    if (!nomeFamiglia) return alert("Seleziona la famiglia!");
    localStorage.setItem("famiglia", nomeFamiglia);
    
    const ordine = [];
    let erroreGiacenza = false;

    prodottiGlobal.forEach((p, i) => {
      if (erroreGiacenza) return;

      const qInput = document.getElementById(`qta-${i}`);
      if (!qInput) return;

      const q = parseInt(qInput.value) || 0;
      const n = document.getElementById(`nota-${i}`)?.value.trim() || "";
      
      if (q > 0) { 
        if (q > p.giacenza) {
            alert(`‚õî ATTENZIONE: Quantit√† per "${p.tipo}" non disponibile.\nHai inserito ${q}, ma sono disponibili solo ${p.giacenza} pezzi.`);
            erroreGiacenza = true;
            return;
        }
        if (!n) { 
            alert(`Inserisci una nota (Chi?) per ${p.tipo}`); 
            erroreGiacenza = true;
            return; 
        }
        ordine.push({ nome: nomeFamiglia, prodotto: p.tipo, quantita: q, nota: n }); 
      }
    });

    if (erroreGiacenza) return;
    if (ordine.length === 0) return alert("Nessun prodotto selezionato.");
    
    payloadTemporaneo = ordine;
    let text = `Nuova Prenotazione:\n`;
    ordine.forEach(o => text += `‚Ä¢ ${o.prodotto}: ${o.quantita} (${o.nota})\n`);
    
    document.getElementById("titoloModal").innerText = "Conferma Ordine";
    document.getElementById("riepilogoCorpo").innerText = text;
    document.getElementById("modal").style.display = "flex";
  }

  function preparaModificaDettaglio() {
    const fam = document.getElementById("nome").value;
    const modifiche = [];
    let riepilogoTesto = `‚ö†Ô∏è MODIFICA ESISTENTE\n\n`;
    
    const variazioniTotali = {};

    document.querySelectorAll(".card-persona").forEach(card => {
        const inAdds = card.querySelectorAll(".in-add");
        const inSubs = card.querySelectorAll(".in-sub");
        
        inAdds.forEach((el, i) => {
            const add = parseInt(el.value) || 0;
            const sub = parseInt(inSubs[i].value) || 0;
            const netto = add - sub;
            
            if (netto !== 0) {
                const prod = el.dataset.prod;
                const pers = el.dataset.pers;
                
                variazioniTotali[prod] = (variazioniTotali[prod] || 0) + netto;
                
                modifiche.push({ 
                    nome: fam, 
                    prodotto: prod, 
                    quantita: netto, 
                    nota: pers 
                });
                
                const azione = netto > 0 ? 'Aggiunti' : 'Sottratti';
                riepilogoTesto += `‚Ä¢ ${pers} | ${prod}: ${netto > 0 ? '+' : ''}${netto} (${azione})\n`;
            }
        });
    });

    if (modifiche.length === 0) return alert("Nessuna modifica inserita.");

    for (const [prod, qtaNettaRichiesta] of Object.entries(variazioniTotali)) {
        if (qtaNettaRichiesta > 0) {
            const p = prodottiGlobal.find(x => x.tipo === prod);
            if (p && qtaNettaRichiesta > p.giacenza) {
                alert(`‚õî ATTENZIONE: Overbooking per "${prod}".\nHai richiesto un totale di +${qtaNettaRichiesta} pezzi extra, ma in magazzino ne sono disponibili solo ${p.giacenza}.`);
                return;
            }
        }
    }

    payloadTemporaneo = modifiche;
    document.getElementById("titoloModal").innerText = "Conferma Modifiche";
    document.getElementById("riepilogoCorpo").innerText = riepilogoTesto;
    document.getElementById("modal").style.display = "flex";
  }

  async function eseguiOperazioneBackend() {
    const overlay = document.getElementById("loading-overlay");
    const statusBox = document.getElementById("status-message");
    
    overlay.style.display = "flex";
    chiudiModal();
    document.getElementById("modal-dettaglio-persone").style.display = "none";

    try {
        const res = await fetch(scriptUrl, {
            method: "POST",
            body: JSON.stringify({ action: "prenota", ordine: payloadTemporaneo })
        });
        await res.json();

        await caricaDati();
        await mostraRiepilogoPrenotazioni(true); 

        overlay.style.display = "none";

        statusBox.innerText = "‚úÖ ORDINE CONFERMATO";
        statusBox.className = "status-success";
        statusBox.style.display = "block";

        setTimeout(() => {
            statusBox.style.display = "none";
        }, 2000);

    } catch (e) {
        overlay.style.display = "none";
        statusBox.innerText = "‚ùå ORDINE NON CONFERMATO!!!";
        statusBox.className = "status-error";
        statusBox.style.display = "block";
        
        console.error("Errore:", e);

        setTimeout(() => {
            statusBox.style.display = "none";
        }, 3500);
    }
  }

  async function mostraRiepilogoPrenotazioni(silenzioso = false) {
    const fam = document.getElementById("nome").value;
    const cont = document.getElementById("contenuto-riepilogo");
    if (!silenzioso) {
        cont.innerHTML = `<div class="spinner"></div> Caricamento...`;
        document.getElementById("modal-riepilogo").style.display = "flex";
    }

    try {
      const res = await fetch(`${scriptUrl}?action=riepilogo&nominativo=${encodeURIComponent(fam)}`);
      const data = await res.json();
      let html = `<div style="background:#e8f5e9; padding:10px; border-radius:8px; margin-bottom:15px; border: 1px solid #a5d6a7;"><strong>${fam}</strong> - Totale: ${data.totaleProdotti}</div>`;
      html += `<div class="table-wrapper"><table style="width:100%; font-size:1.1rem;"><tr style="background:#2e7d32; color:white;"><th style="text-align:left; padding:12px; background:#2e7d32;">Prodotto</th><th style="width:30%; background:#2e7d32;">Qt√†</th></tr>`;
      data.riepilogoArray.filter(x => x.valore > 0).forEach(item => {
        html += `<tr><td style="text-align:left; padding:12px;">${item.prodotto}</td><td style="font-weight:bold; font-size:1.3rem;">${item.valore}</td></tr>`;
      });
      html += `</table></div><h3 style="text-align:right; color:#2e7d32;">Totale: ‚Ç¨ ${data.totaleDaPagare}</h3><button class="btn-dark" onclick="mostraDettaglioPerPersone()">Dettaglio per Singola Persona</button>`;
      cont.innerHTML = html;
      if (silenzioso) document.getElementById("modal-riepilogo").style.display = "flex";
    } catch (e) { cont.innerHTML = "Errore: " + e.message; }
  }

  async function mostraDettaglioPerPersone() {
    document.getElementById("modal-riepilogo").style.display = "none";
    const fam = document.getElementById("nome").value;
    const cont = document.getElementById("contenuto-dettaglio");
    cont.innerHTML = `<div class="spinner"></div> Caricamento dettagli...`;
    document.getElementById("modal-dettaglio-persone").style.display = "flex";
    try {
      const res = await fetch(`${scriptUrl}?action=dettaglio&nominativo=${encodeURIComponent(fam)}`);
      const persone = await res.json();
      let html = "";
      persone.forEach((pers) => {
        let totPers = 0;
        html += `<div class="card-persona"><h4>üë§ ${pers.nominativo}</h4><div class="table-wrapper"><table style="width:100%;"><tr style="font-size:0.8rem; background:#f0f0f0;"><th style="color:black; background:#eee; text-align:left;">Prodotto</th><th style="color:black; background:#eee; width:15%;">Att.</th><th style="color:green; background:#eee; width:20%;">+</th><th style="color:red; background:#eee; width:20%;">-</th></tr>`;
        for (const [prod, qta] of Object.entries(pers.prodotti)) {
          totPers += (qta * getPrezzo(prod));
          html += `<tr><td style="text-align:left;">${prod}</td><td><strong>${qta}</strong></td><td><input type="number" class="in-add" data-pers="${pers.nominativo}" data-prod="${prod}" value="0" min="0"></td><td><input type="number" class="in-sub" data-pers="${pers.nominativo}" data-prod="${prod}" value="0" min="0" max="${qta}"></td></tr>`;
        }
        html += `</table></div><div style="text-align:right; margin-top:10px; font-weight:bold; color:#2e7d32;">Parziale: ‚Ç¨ ${totPers}</div></div>`;
      });
      cont.innerHTML = html || "Nessun dato.";
    } catch (e) { cont.innerHTML = "Errore: " + e.message; }
  }

  function chiudiModal() { document.getElementById("modal").style.display = "none"; }
  window.onload = caricaDati;
</script>
</body>
</html>
